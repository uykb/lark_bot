# 飞书考勤统计机器人

一个基于 飞书应用开发包 (Lark App Engine)实现 部署的飞书考勤统计机器人，可以自动统计员工的考勤数据并通过飞书机器人推送到群聊。

## 功能特性

- 🔄 自动获取飞书考勤数据
- 📊 按周统计考勤情况
- 🤖 通过飞书机器人推送统计结果
- ⏰ 支持定时任务（每周一自动统计）
- ☁️ 基于 replit 部署，无需服务器
- 📈 支持部门统计和工作时长分析
- 🎨 美观的卡片消息展示
- 🔧 高度可配置的统计规则

## 技术栈

- Node.js
- 飞书开放平台 API
- node-schedule（定时任务）
- axios（HTTP 请求）
- dotenv（环境变量管理）

## 部署步骤

### 1. 创建飞书应用

1. 登录[飞书开放平台](https://open.feishu.cn/)
2. 创建企业自建应用
3. 在应用功能中开启机器人功能
4. 获取应用凭证（App ID 和 App Secret）
5. 配置以下权限：
   - 考勤信息查看权限
   - 消息发送权限
   - 用户信息读取权限

### 2. 配置环境变量

在 replit 中配置以下环境变量：

- `APP_ID`: 飞书应用的 App ID
- `APP_SECRET`: 飞书应用的 App Secret
- `CRON_SCHEDULE`: 定时任务执行时间，默认为每周一上午9点（'0 1 * * 1'）
- `WEBHOOK_URL`: 飞书群聊机器人的 Webhook 地址（可选，如不配置则使用应用消息发送）
- `LOG_LEVEL`: 日志级别，可选值：debug、info、warn、error（默认：info）

### 3. 运行项目

```bash
# 安装依赖
npm install

# 启动项目
npm start
```

## 配置说明

### 定时任务配置

通过环境变量 `CRON_SCHEDULE` 配置，使用 cron 表达式格式：

```
┌───────────── 分钟 (0 - 59)
│ ┌───────────── 小时 (0 - 23)
│ │ ┌───────────── 日 (1 - 31)
│ │ │ ┌───────────── 月 (1 - 12)
│ │ │ │ ┌───────────── 星期 (0 - 6)（星期日为0）
│ │ │ │ │
│ │ │ │ │
* * * * *
```

示例：
- 每周一上午9点：`0 1 * * 1`
- 每天上午10点：`0 2 * * *`
- 每周一和周四上午9点：`0 1 * * 1,4`

### 统计规则配置

考勤统计支持以下规则配置：

- 工作时长计算：自动计算每日工作时长，支持考虑午休时间
- 迟到早退判定：可配置弹性工作时间
- 加班时长统计：支持节假日和周末加班统计
- 请假统计：支持各类请假类型统计

## 常见问题

### Q: 如何修改消息推送模板？

A: 在 `src/utils/cardGenerator.js` 文件中修改消息卡片模板。

### Q: 如何调整统计时间范围？

A: 在 `src/services/attendanceService.js` 中修改 `getAttendanceData` 函数的查询参数。

### Q: 遇到 API 调用失败怎么办？

A: 检查以下几点：
1. 环境变量配置是否正确
2. 应用权限是否已获得审批
3. 查看日志中的详细错误信息

## 贡献指南

1. Fork 本仓库
2. 创建功能分支：`git checkout -b feature/AmazingFeature`
3. 提交更改：`git commit -m 'Add some AmazingFeature'`
4. 推送分支：`git push origin feature/AmazingFeature`
5. 提交 Pull Request

## 许可证

本项目基于 MIT 许可证开源，详见 [LICENSE](LICENSE) 文件。